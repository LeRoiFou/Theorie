<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mise √† jour Application FastAPI</title>
    <link rel="stylesheet" href="index_ovhXX1.css">
</head>

<body>

    <div class="container">
        <h1>üîÑ Mise √† Jour Application FastAPI - Impact & Proc√©dure</h1>

        <h2 id="menu">üë®‚Äçüç≥ Menu</h2>
        <div class="diagram">
            üöÄ Proc√©dure de mise √† jour
            ‚îú‚îÄ‚îÄ √âTAPE 1Ô∏è‚É£ : LOCAL - Pr√©parer la nouvelle image
            ‚îú‚îÄ‚îÄ √âTAPE 2Ô∏è‚É£ : VM - Charger la nouvelle image
            ‚îú‚îÄ‚îÄ √âTAPE 3Ô∏è‚É£ : VM - Arr√™ter l'ancienne version (‚ö†Ô∏è DOWNTIME ~10-30 sec)
            ‚îú‚îÄ‚îÄ √âTAPE 4Ô∏è‚É£ : VM - Lancer la nouvelle version
            ‚îú‚îÄ‚îÄ √âTAPE 5Ô∏è‚É£ : V√âRIFICATION - Tester la nouvelle version
            ‚îî‚îÄ‚îÄ √âTAPE 6Ô∏è‚É£ : OPTIONNEL - Nettoyer les anciennes versions

            üìã R√©sum√© des impacts

            üîÑ Rollback en cas de probl√®me (urgent)
        </div>

        <h2>üìä Vue d'ensemble : Qu'est-ce qui change ?</h2>
        <div class="diagram">
            AVANT MISE √Ä JOUR
            ‚îú‚îÄ‚îÄ Docker conteneur (v1) ‚ùå √Ä REMPLACER
            ‚îú‚îÄ‚îÄ Nginx (reverse proxy) ‚úÖ INCHANG√â
            ‚îú‚îÄ‚îÄ Certbot (SSL/HTTPS) ‚úÖ INCHANG√â
            ‚îî‚îÄ‚îÄ Firewall UFW ‚úÖ INCHANG√â

            APR√àS MISE √Ä JOUR
            ‚îú‚îÄ‚îÄ Docker conteneur (v2) ‚úÖ NOUVEAU
            ‚îú‚îÄ‚îÄ Nginx (reverse proxy) ‚úÖ INCHANG√â
            ‚îú‚îÄ‚îÄ Certbot (SSL/HTTPS) ‚úÖ INCHANG√â
            ‚îî‚îÄ‚îÄ Firewall UFW ‚úÖ INCHANG√â
        </div>

        <!-- ZONE DE SAISIE -->
        <div class="section-title">ZONE DE SAISIE DES DONNEES</div>

        <label for="repository">REPOSITORY</label>
        <input type="text" name="repository" id="repository" placeholder="Commande dans le shell : 'docker images'"
            title="Charger pr√©alablement docker desktop (image = REPOSITORY:TAG)"><br>

        <label for="tag">TAG</label>
        <input type="text" name="tag" id="tag" placeholder="Commande dans le shell : 'docker images'"
            title="Par d√©faut, le nom de la version de l'image est latest"
            title="Charger pr√©alablement docker desktop"><br>

        <label for="containerID">CONTAINER ID</label>
        <input type="text" name="containerID" id="containerID" placeholder="Commande dans le shell : docker ps -a"
            title="Charger pr√©alablement docker desktop"><br>

        <label for="containerName">CONTAINER NAME</label>
        <input type="text" name="containerName" id="containerName" placeholder="Commande dans le shell : docker ps -a"
            title="Charger pr√©alablement docker desktop - nom du conteneur"><br>

        <label for="network">PORT</label>
        <input type="text" name="network" id="network" placeholder="8000 pour fastapi, 8050 pour dash"><br>

        <label for="key">CLE</label>
        <input type="text" name="key" id="key" value="id_ed25519"
            title="Nom par d√©faut de la cl√© priv√©e attribu√© par OVH"><br>

        <label for="ipv4">IPv4</label>
        <input type="text" name="ipv4" id="ipv4" placeholder="Adresse IPv4 sur OVH du projet cibl√©"><br>

        <label for="images">IMAGE</label>
        <input type="text" name="images" id="images" placeholder="Nom commun de l'ancien et de la nouvelle image"
            title="Exemple : projet003"><br>

        <label for="prevContainerID">Ancien CONTAINER ID</label>
        <input type="text" name="prevContainerID" id="prevContainerID"
            placeholder="Commande dans le shell de la VM : 'docker ps'" title="Conteneur actif dans la VM"><br>

        <label for="prevContainerName">Ancien CONTAINER NAME</label>
        <input type="text" name="prevContainerName" id="prevContainerName"
            placeholder="Commande dans le shell de la VM : 'docker ps'" title="Conteneur actif dans la VM"><br>

        <button type="submit" id="btn">Valider</button>

        <h2>üöÄ Proc√©dure de mise √† jour</h2>

        <!-- √âTAPE 1 : LOCAL -->
        <div class="section-title">
            √âTAPE 1Ô∏è‚É£ : LOCAL - Pr√©parer la nouvelle image
        </div>
        <table>
            <thead>
                <tr>
                    <th width="4%">Shell</th>
                    <th width="48%">Motif</th>
                    <th width="48%">Explications</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="3">
                        <pre>docker build --no-cache -t <span id="repoResp1">[nomImage]</span> .</pre>
                    </td>
                </tr>
                <tr class="local">
                    <td>Local</td>
                    <td>Construire la nouvelle image Docker (repository dans le shell)</td>
                    <td>‚è±Ô∏è 2-5 min selon taille</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre>docker run -p <span id="networkResp1">[PORT]</span>:<span id="networkResp2">[PORT]</span> <span id="repoResp2">[nomImage]</span></pre>
                    </td>
                </tr>
                <tr class="local">
                    <td>Local</td>
                    <td>Lancement du conteneur</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre>docker images</pre>
                    </td>
                <tr class="local">
                    <td>Local</td>
                    <td>R√©cup√©rer REPOSITORY et TAG de ton image</td>
                    <td>Affiche toutes les images disponibles
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>docker ps -a</code></pre>
                    </td>
                </tr>
                <tr>
                    <td>Local</td>
                    <td>Permet d'afficher la liste des conteneurs ex√©cut√©s / arr√™t√©s, avec les statuts
                        suivants :
                        <ul>
                            <li>Exited (0) : <i>aucune erreur</i></li>
                            <li>Exited (1) : <i>au moins une erreur pr√©sente</i></li>
                            <li>Exited (137) : <i>conteneur arr√™t√© / forc√© / manque de m√©moire</i>
                            </li>
                        </ul>
                    </td>
                    <td>
                        <ul>
                            <li><b>ps</b> : vient de ‚Äúprocess status‚Äù. Historiquement, ps est une
                                commande
                                Unix qui affiche l‚Äô√©tat des processus en cours, et
                                Docker a
                                repris ce nom pour afficher l‚Äô√©tat des conteneurs
                            </li>
                            <li><b>-a</b> : signifie 'all'</li>
                        </ul>
                    </td>
                <tr>
                    <td colspan="3">
                        <pre><code>docker logs <span id="containerIDResp1">[CONTAINER_ID]</span></code></pre>
                    </td>
                </tr>
                <tr>
                    <td>Local</td>
                    <td>Si un des conteneurs a le statut Exited (1) ou Exited (137)</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>docker save <span id="repoResp3">[REPOSITORY]</span>:<span id="tagResp1">[TAG]</span> -o <span id="repoResp4">[REPOSITORY]</span>.tar</code></pre>
                    </td>
                </tr>
                <tr class="local">
                    <td>Local</td>
                    <td>Exporter l'image en fichier .tar</td>
                    <td><strong>-o</strong> : output
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>ls -lh <span id="repoResp5">[REPOSITORY]</span>.tar</code></pre>
                    </td>
                </tr>
                <tr class="local">
                    <td>Local</td>
                    <td>V√©rifier que le .tar existe</td>
                    <td><strong>ls -lh</strong> : liste d√©taill√©e avec taille lisible (Mo, Go). Si absent, l'export a
                        √©chou√©
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>scp -i $env:USERPROFILE\.ssh\<span id="keyResp1">[CLE]</span> <span id="repoResp6">[REPOSITORY]</span>.tar ubuntu@<span
                                                id="ipv4Resp1">[IPV4]</span>:/home/ubuntu/</code></pre>
                    </td>
                </tr>
                <tr class="local">
                    <td>Local</td>
                    <td>Copier le fichier .tar vers le VM</td>
                    <td><strong>scp</strong> : Secure Copy via SSH</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>ssh -i $env:USERPROFILE\.ssh\<span id="keyResp2">[CLE]</span> ubuntu@<span
                                                id="ipv4Resp2">[IPV4]</span></code></pre>
                    </td>
                </tr>
                <tr class="local">
                    <td>Local</td>
                    <td>Se connecter au VM en SSH</td>
                    <td>Tu entres maintenant dans le shell du VM</td>
                </tr>
            </tbody>
        </table>

        <!-- √âTAPE 2 : VM -->
        <div class="section-title">
            √âTAPE 2Ô∏è‚É£ : VM - Charger la nouvelle image
        </div>
        <table>
            <thead>
                <tr>
                    <th width="4%">Shell</th>
                    <th width="48%">Motif</th>
                    <th width="48%">Explications</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="3">
                        <pre>docker load -i <span id="repoResp7">[REPOSITORY]</span>.tar</pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Charger la nouvelle image Docker</td>
                    <td>Cr√©e l'image v1 dans Docker. L'ancienne (v0) reste aussi disponible</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre>docker images | grep <span id="imagesResp1">[IMAGE]</span></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>V√©rifier que les 2 images coexistent</td>
                    <td>Affiche
                        <pre><code>...version0:0</code> et <pre><code>...version0:1</code> ‚úÖ</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre>docker ps</pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Voir le conteneur actif (ancienne version)</td>
                    <td>-</td>
                </tr>
            </tbody>
        </table>

        <!-- √âTAPE 3 : ARR√äT ANCIEN CONTENEUR -->
        <div class="section-title">
            √âTAPE 3Ô∏è‚É£ : VM - Arr√™ter l'ancienne version (‚ö†Ô∏è DOWNTIME ~10-30 sec)
        </div>
        <table>
            <thead>
                <tr>
                    <th width="4%">Shell</th>
                    <th width="48%">Motif</th>
                    <th width="48%">Explications</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="3">
                        <pre>docker stop <span id="prevContainerIDResp1">[ancien CONTAINER ID]</span></pre>
                    </td>
                </tr>
                <tr class="warning">
                    <td>VM</td>
                    <td>Arr√™ter le conteneur actif</td>
                    <td><strong>ATTENTION :</strong> √Ä ce moment, l'app est DOWN (non accessible). Dur√©e : ~5-10 sec.
                        Nginx affichera "502 Bad Gateway" pour les utilisateurs</td>
                </tr>
            </tbody>
        </table>

        <!-- √âTAPE 4 : LANCEMENT NOUVEAU CONTENEUR -->
        <div class="section-title">
            √âTAPE 4Ô∏è‚É£ : VM - Lancer la nouvelle version
        </div>
        <table>
            <thead>
                <tr>
                    <th width="4%">Shell</th>
                    <th width="48%">Motif</th>
                    <th width="48%">Explications</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="3">
                        <pre>docker run -d --restart unless-stopped --name <span id="containerNameResp1">[CONTAINER NAME]</span> -p <span id="networkResp3">[PORT]</span>:<span id="networkResp4">[PORT]</span> <span id="repoResp8">[REPOSITORY]</span>:<span id="tagResp2">[TAG]</span></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Lancer le nouveau conteneur</td>
                    <td><strong>--name <span id="containerNameResp2">[CONTAINER NAME]</span></strong> : cr√©e le
                        conteneur avec un nouveau nom <br>
                        ‚è±Ô∏è 3-10 sec pour d√©marrer
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre>docker ps</pre>
                    </td>
                </tr>
                <tr class="safe">
                    <td>VM</td>
                    <td>V√©rifier que la nouvelle version du conteneur tourne</td>
                    <td>Doit afficher
                        <pre><code><span id="containerNameResp3">[CONTAINER NAME]</span></code> avec <pre><code>STATUS: Up X seconds</code> 
                    <p>‚úÖ L'app est de retour en ligne !</p></td>
                </tr>
            </tbody>
        </table>

        <!-- √âTAPE 5 : V√âRIFICATION -->
        <div class="section-title">
        √âTAPE 5Ô∏è‚É£ : V√âRIFICATION - Tester la nouvelle version
        </div>
        <table>
            <thead>
                <tr>
                    <th width="4%">Shell</th>
                    <th width="48%">Motif</th>
                    <th width="48%">Explications</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="3">
                        <pre>curl https://sous-domaine.fr/docs</pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Tester l'acc√®s</td>
                    <td>Doit retourner du HTML</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre>docker logs <span id="containerNameResp4">[CONTAINER NAME]</span></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Si erreur 502 ou timeout</td>
                    <td>Affiche les logs du conteneur pour diagnostiquer le probl√®me</td>
                </tr>
            </tbody>
        </table>


        <!-- √âTAPE 6 : OPTIONNEL - NETTOYAGE -->
        <div class="section-title">
            √âTAPE 6Ô∏è‚É£ : OPTIONNEL - Nettoyer les anciennes versions
        </div>
        <table>
            <thead>
                <tr>
                    <th width="4%">Shell</th>
                    <th width="48%">Motif</th>
                    <th width="48%">Explications</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="3">
                        <pre>docker ps -a | grep <span id="imagesResp2">[IMAGE]</span></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Lister tous les conteneurs avec le m√™me nom commun pour l'image (actifs + arr√™t√©s)</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre>docker rm -f <span id="prevContainerIDResp2">[ancien CONTAINER ID]</span></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Supprimer le conteneur arr√™t√© (ancien)</td>
                    <td><strong>rm - f</strong> = remove force üëâ suppression forc√©e. Cela lib√®re de l'espace
                        disque.<br>
                        ATTENTION : irr√©versible. Si tu
                        veux rollback ultra-rapide, ne fais pas cette √©tape</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre>docker rmi <span id="repoResp9">[REPOSITORY]</span>:<span id="tagResp3">[TAG]</span></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Supprimer l'image Docker ancienne (optionnel)</td>
                    <td><strong>rmi</strong> = remove image. Lib√®re beaucoup d'espace (~500MB-2GB). <br>
                        ATTENTION : si tu red√©ploies, il faudra re-upload l'image. Recommand√© seulement si tu as peu
                        d'espace disque</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre>df -h /</pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>V√©rifier l'espace disque lib√©r√©</td>
                    <td><strong>df -h</strong> : affiche l'utilisation disque. La colonne "Use%" doit diminuer apr√®s le
                        nettoyage</td>
                </tr>
            </tbody>
        </table>

        <h2>üìã R√©sum√© des impacts</h2>
        <table>
            <tbody>
                <tr class="safe">
                    <td width="200px"><strong>‚úÖ Inchang√©</strong></td>
                    <td>Nginx, Certbot, Firewall UFW, certificat SSL, domaine app.datacofi.fr</td>
                </tr>
                <tr class="impact">
                    <td><strong>‚ö†Ô∏è Downtime</strong></td>
                    <td>~10-30 secondes (temps pour arr√™ter l'ancien conteneur et en lancer un nouveau)</td>
                </tr>
                <tr class="safe">
                    <td><strong>‚úÖ Transparent</strong></td>
                    <td>Pour l'utilisateur, c'est comme si rien ne s'√©tait pass√©. HTTPS reste actif pendant toute la
                        mise √† jour (Nginx = reverse proxy, l'acc√®s continue).</td>
                </tr>
            </tbody>
        </table>

        <h2>üîÑ Rollback en cas de probl√®me (urgent)</h2>
        <div class="step">
            <div class="step-title">Si la v1 a un bug critique :</div>
            <ul>
                <li>
                    <pre><code>docker stop <span id="containerNameResp5">[CONTAINER NAME]</span></code> : arr√™te la version buggu√©e</li>
                <li><pre><code>docker start <span id="prevContainerNameResp1">[Ancien CONTAINER NAME]</span></code> : relance l'ancienne version (si pas supprim√©e √† l'√©tape 6)</li>
                <li>Nginx redirige imm√©diatement vers le port <span id="networkResp5">[PORT]</span> ‚Üí ancien conteneur ‚úÖ</li>
                <li>Dur√©e : ~10 sec. D√©pannage rapide !</li>
            </ul>
        </div>
        <br>

        <i><a href="#menu">Retour au menu</a></i><br><br>

        <i><a id='lien' href="./index.html">Retour au sommaire</a></i>
    </div>
    <script src="/index_ovhXX2.js"></script>
</body>

</html>