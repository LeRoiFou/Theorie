<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mise √† jour application</title>
    <link rel="stylesheet" href="styleOVH.css">
</head>

<body>

    <div class="container">
        <h1>üîÑ Mise √† jour d'une application - Impact & Proc√©dure</h1>

        <h2 id="menu">üë®‚Äçüç≥ Menu</h2>
        <div class="diagram">
            <a href="#part1">üöÄ Proc√©dure de mise √† jour</a>
            ‚îú‚îÄ‚îÄ <a href="#part11">√âTAPE 1Ô∏è‚É£ : LOCAL - Pr√©parer la nouvelle image</a>
            ‚îú‚îÄ‚îÄ <a href="#part12">√âTAPE 2Ô∏è‚É£ : VM - Charger la nouvelle image</a>
            ‚îú‚îÄ‚îÄ <a href="#part13">√âTAPE 3Ô∏è‚É£ : VM - Arr√™ter l'ancienne version (‚ö†Ô∏è DOWNTIME ~10-30 sec)</a>
            ‚îú‚îÄ‚îÄ <a href="#part14">√âTAPE 4Ô∏è‚É£ : VM - Lancer la nouvelle version</a>
            ‚îú‚îÄ‚îÄ <a href="#part15">√âTAPE 5Ô∏è‚É£ : V√âRIFICATION - Tester la nouvelle version</a>
            ‚îî‚îÄ‚îÄ <a href="#part16">√âTAPE 6Ô∏è‚É£ : OPTIONNEL - Nettoyer les anciennes versions</a>

            <a href="#part2">üìã R√©sum√© des impacts</a>

            <a href="#part3">üîÑ Rollback en cas de probl√®me (urgent)</a>
        </div>
    </div>

    <h2>‚ÑπÔ∏è Informations</h2>
    <div class="diagram">
        <b>En local :</b>
        ‚îú‚îÄ‚îÄ le backtick ` permet de couper une commande sur plusieurs lignes
        ‚îî‚îÄ‚îÄ On parle de Powershell (ou invite de commandes)

        <b>En VM Unbuntu :</b>
        ‚îú‚îÄ‚îÄ l'anti slache \ permet de couper une commande sur plusieurs lignes
        ‚îî‚îÄ‚îÄ On parle de shell bash (via SSH)
    </div>

    <h2>üìä Vue d'ensemble : Qu'est-ce qui change ?</h2>
    <div class="diagram">
        AVANT MISE √Ä JOUR
        ‚îú‚îÄ‚îÄ Docker conteneur (v1) ‚ùå √Ä REMPLACER
        ‚îú‚îÄ‚îÄ Nginx (reverse proxy) ‚úÖ INCHANG√â
        ‚îú‚îÄ‚îÄ Certbot (SSL/HTTPS) ‚úÖ INCHANG√â
        ‚îî‚îÄ‚îÄ Firewall UFW ‚úÖ INCHANG√â

        APR√àS MISE √Ä JOUR
        ‚îú‚îÄ‚îÄ Docker conteneur (v2) ‚úÖ NOUVEAU
        ‚îú‚îÄ‚îÄ Nginx (reverse proxy) ‚úÖ INCHANG√â
        ‚îú‚îÄ‚îÄ Certbot (SSL/HTTPS) ‚úÖ INCHANG√â
        ‚îî‚îÄ‚îÄ Firewall UFW ‚úÖ INCHANG√â
    </div>

    <!-- ZONE DE SAISIE -->
    <div class="section-title" id="part1">ZONE DE SAISIE DES DONNEES</div>

    <label for="repository">REPOSITORY</label>
    <input type="text" name="repository" id="repository" placeholder="Commande dans le shell : 'docker images'"
        title="Charger pr√©alablement docker desktop (image = REPOSITORY:TAG)"><br>

    <label for="tag">TAG</label>
    <input type="text" name="tag" id="tag" placeholder="Commande dans le shell : 'docker images'"
        title="Par d√©faut, le nom de la version de l'image est latest" title="Charger pr√©alablement docker desktop"><br>

    <label for="containerID">CONTAINER ID</label>
    <input type="text" name="containerID" id="containerID" placeholder="Commande dans le shell : docker ps -a"
        title="Charger pr√©alablement docker desktop"><br>

    <label for="containerName">CONTAINER NAME</label>
    <input type="text" name="containerName" id="containerName" placeholder="Commande dans le shell : docker ps -a"
        title="Charger pr√©alablement docker desktop - nom du conteneur"><br>

    <label for="network">PORT LOCAL</label>
    <input type="text" name="network" id="network" placeholder="8000 pour fastapi, 8050 pour dash"><br>

    <label for="networkVM">PORT RESEAU</label>
    <input type="text" name="networkVM" id="networkVM"
        placeholder="8000 pour le sous-domaine n¬∞1, 8001 pour le sous-domaine 2..."><br>

    <label for="key">CLE</label>
    <input type="text" name="key" id="key" value="id_ed25519"
        title="Nom par d√©faut de la cl√© priv√©e attribu√© par OVH"><br>

    <label for="ipv4">IPv4</label>
    <input type="text" name="ipv4" id="ipv4" placeholder="Adresse IPv4 sur OVH du projet cibl√©"><br>

    <label for="images">IMAGE</label>
    <input type="text" name="images" id="images" placeholder="Nom commun de l'ancien et de la nouvelle image"
        title="Exemple : projet003"><br>

    <label for="prevContainerID">Ancien CONTAINER ID</label>
    <input type="text" name="prevContainerID" id="prevContainerID"
        placeholder="Commande dans le shell de la VM : 'docker ps'" title="Conteneur actif dans la VM"><br>

    <label for="prevContainerName">Ancien CONTAINER NAME</label>
    <input type="text" name="prevContainerName" id="prevContainerName"
        placeholder="Commande dans le shell de la VM : 'docker ps'" title="Conteneur actif dans la VM"><br>

    <label for="prevRepository">Ancien REPOSITORY</label>
    <input type="text" name="prevRepository" id="prevRepository"
        placeholder="Commande dans le shell de la VM : 'docker images'" title="Image active dans la VM"><br>

    <label for="prevTag">Ancien TAG</label>
    <input type="text" name="prevTag" id="prevTag" placeholder="Commande dans le shell de la VM : 'docker images'"
        title="Version de l'image active dans la VM"><br>

    <button type="submit" id="btn">Valider</button>

    <h2>üöÄ Proc√©dure de mise √† jour</h2>

    <!-- √âTAPE 1 : LOCAL -->
    <div class="section-title" id="part11">
        √âTAPE 1Ô∏è‚É£ : LOCAL - Pr√©parer la nouvelle image
    </div>
    <table>
        <thead>
            <tr>
                <th width="4%">Shell</th>
                <th width="48%">Motif</th>
                <th width="48%">Explications</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="3">
                    <pre>docker images</pre>
                </td>
            <tr class="local">
                <td>Local</td>
                <td>R√©cup√©rer REPOSITORY et TAG de ton image</td>
                <td>Affiche toutes les images disponibles
            </tr>
            <tr>
                <td colspan="3">
                    <pre><code>docker ps -a</code></pre>
                </td>
            </tr>
            <tr>
                <td>Local</td>
                <td>Permet d'afficher la liste des conteneurs ex√©cut√©s / arr√™t√©s, avec les statuts
                    suivants :
                    <ul>
                        <li>Exited (0) : <i>aucune erreur</i></li>
                        <li>Exited (1) : <i>au moins une erreur pr√©sente</i></li>
                        <li>Exited (137) : <i>conteneur arr√™t√© / forc√© / manque de m√©moire</i>
                        </li>
                    </ul>
                </td>
                <td>
                    <ul>
                        <li><b>ps</b> : vient de ‚Äúprocess status‚Äù. Historiquement, ps est une
                            commande
                            Unix qui affiche l‚Äô√©tat des processus en cours, et
                            Docker a
                            repris ce nom pour afficher l‚Äô√©tat des conteneurs
                        </li>
                        <li><b>-a</b> : signifie 'all'</li>
                    </ul>
                </td>
            <tr>
                <td colspan="3">
                    <pre><code>docker logs <span id="containerIDResp1">[CONTAINER_ID]</span></code></pre>
                </td>
            </tr>
            <tr>
                <td>Local</td>
                <td>Si un des conteneurs a le statut Exited (1) ou Exited (137)</td>
                <td>-</td>
            </tr>
            <tr>
                <td colspan="3">
                    <pre><code>docker save <span id="repoResp1">[REPOSITORY]</span>:<span id="tagResp1">[TAG]</span> -o <span id="repoResp2">[REPOSITORY]</span>.tar</code></pre>
                </td>
            </tr>
            <tr class="local">
                <td>Local</td>
                <td>Exporter l'image en fichier .tar</td>
                <td><strong>-o</strong> : output
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <pre><code>ls <span id="repoResp3">[REPOSITORY]</span>.tar</code></pre>
                </td>
            </tr>
            <tr class="local">
                <td>Local</td>
                <td>V√©rifier que le .tar existe</td>
                <td><strong>ls</strong> : liste d√©taill√©e avec taille lisible. Si absent, l'export a
                    √©chou√©
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <pre><code>scp -i $env:USERPROFILE\.ssh\<span id="keyResp1">[CLE]</span> <span id="repoResp4">[REPOSITORY]</span>.tar ubuntu@<span
                                                id="ipv4Resp1">[IPV4]</span>:/home/ubuntu/</code></pre>
                </td>
            </tr>
            <tr class="local">
                <td>Local</td>
                <td>Copier le fichier .tar vers le VM</td>
                <td><strong>scp</strong> : Secure Copy via SSH</td>
            </tr>
            <tr>
                <td colspan="3">
                    <pre><code>ssh -i $env:USERPROFILE\.ssh\<span id="keyResp2">[CLE]</span> ubuntu@<span
                                                id="ipv4Resp2">[IPV4]</span></code></pre>
                </td>
            </tr>
            <tr class="local">
                <td>Local</td>
                <td>Se connecter au VM en SSH</td>
                <td>Tu entres maintenant dans le shell du VM</td>
            </tr>
        </tbody>
    </table>

    <!-- √âTAPE 2 : VM -->
    <div class="section-title" id="part12">
        √âTAPE 2Ô∏è‚É£ : VM - Charger la nouvelle image
    </div>
    <table>
        <thead>
            <tr>
                <th width="4%">Shell</th>
                <th width="48%">Motif</th>
                <th width="48%">Explications</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="3">
                    <pre>docker load -i <span id="repoResp5">[REPOSITORY]</span>.tar</pre>
                </td>
            </tr>
            <tr class="vm">
                <td>VM</td>
                <td>Charger la nouvelle image Docker</td>
                <td>Cr√©e l'image v1 dans Docker. L'ancienne (v0) reste aussi disponible</td>
            </tr>
            <tr>
                <td colspan="3">
                    <pre>docker images | grep <span id="imagesResp1">[IMAGE]</span></pre>
                </td>
            </tr>
            <tr class="vm">
                <td>VM</td>
                <td>V√©rifier que les 2 images coexistent</td>
                <td>Affiche
                    <pre><code>...version0:0</code> et <pre><code>...version0:1</code> ‚úÖ</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre>docker ps</pre>
                </td>
            </tr>
            <tr class="vm">
                <td>VM</td>
                <td>Voir le conteneur actif (ancienne version)</td>
                <td>-</td>
            </tr>
        </tbody>
    </table>

    <!-- √âTAPE 3 : ARR√äT ANCIEN CONTENEUR -->
    <div class="section-title" id="part13">
        √âTAPE 3Ô∏è‚É£ : VM - Arr√™ter l'ancienne version (‚ö†Ô∏è DOWNTIME ~10-30 sec)
    </div>
    <table>
        <thead>
            <tr>
                <th width="4%">Shell</th>
                <th width="48%">Motif</th>
                <th width="48%">Explications</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="3">
                    <pre>docker stop <span id="prevContainerIDResp1">[ancien CONTAINER ID]</span></pre>
                </td>
            </tr>
            <tr class="warning">
                <td>VM</td>
                <td>Arr√™ter le conteneur actif</td>
                <td><strong>ATTENTION :</strong> √Ä ce moment, l'app est DOWN (non accessible). Dur√©e : ~5-10 sec.
                    Nginx affichera "502 Bad Gateway" pour les utilisateurs</td>
            </tr>
        </tbody>
    </table>

    <!-- √âTAPE 4 : LANCEMENT NOUVEAU CONTENEUR -->
    <div class="section-title" id="part14">
        √âTAPE 4Ô∏è‚É£ : VM - Lancer la nouvelle version
    </div>
    <table>
        <thead>
            <tr>
                <th width="4%">Shell</th>
                <th width="48%">Motif</th>
                <th width="48%">Explications</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="3">
                    <pre><code>export MAILJET_API_KEY="ta_cle_api"</code></pre>
                    <pre><code>export MAILJET_API_SECRET="ton_secret_api"</code></pre>
                </td>
            </tr>
            <tr class="vm">
                <td>VM</td>
                <td colspan="2">Si recours √† des cl√©s</td>
            </tr>
            <tr>
                <td colspan="3">
                    <pre><code>docker run -d \<br>--restart unless-stopped \<br>-p <span id="networkVMResp1">[PORT RESEAU]</span>:<span id="networkResp1">[PORT LOCAL]</span> \<br>-v /home/ubuntu/enregistrements_formulaires:/app/Enregistrements \<br>--e MAILJET_API_KEY="$MAILJET_API_KEY" \<br>--e MAILJET_API_SECRET="$MAILJET_API_SECRET" \<br>--e COOKIE_SECURE=1 \<br>--name <span id="containerNameResp1">[CONTAINER NAME]</span> \<br><span id="repoResp6">[REPOSITORY]</span>:<span id="tagResp2">[TAG]</span></code></pre>
                </td>
            </tr>
            <tr class="vm">
                <td>VM</td>
                <td>Lancer le nouveau conteneur</td>
                <td>
                    <ul>
                        <li><b>-d</b> : mode d√©tach√© (arri√®re-plan)</li>
                        <li><b>--restart unless-stopped</b> : relance auto si crash <br></li>
                        <li><b>-p PORT RESEAU:PORT LOCAL</b> : mappe port interne au port VM (se lit √†
                            l'envers)</li>
                        <li><b>-v /home/ubuntu/enregistrements_formulaires:/app/Enregistrements</b> : si export des
                            donn√©es en tant qu'admin</li>
                        <li><b>--e MAILJET_API_KEY="$MAILJET_API_KEY"</b></li> : si pr√©sence d'une cl√© API de
                        MAILJET
                        <li><b>--e MAILJET_API_SECRET="$MAILJET_API_SECRET"</b> : </li> si pr√©sence d'un MDP API de
                        MAILJET
                        <li><b>--e COOKIE_SECURE=1</b> : si pr√©sence de cookies</li>
                        <li><b>--name <span id="containerNameResp2">[CONTAINER NAME]</span></b> : cr√©e le
                            conteneur avec un nouveau nom</li>
                    </ul>
                    <br>
                    ‚è±Ô∏è 3-10 sec pour d√©marrer
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <pre>docker ps</pre>
                </td>
            </tr>
            <tr class="safe">
                <td>VM</td>
                <td>V√©rifier que la nouvelle version du conteneur tourne</td>
                <td>Doit afficher
                    <pre><code><span id="containerNameResp3">[CONTAINER NAME]</span></code> avec <pre><code>STATUS: Up X seconds</code> 
                    <p>‚úÖ L'app est de retour en ligne !</p></td>
                </tr>
            </tbody>
        </table>

        <!-- √âTAPE 5 : V√âRIFICATION -->
        <div class="section-title" id="part15">
        √âTAPE 5Ô∏è‚É£ : V√âRIFICATION - Tester la nouvelle version
        </div>
        <table>
            <thead>
                <tr>
                    <th width="4%">Shell</th>
                    <th width="48%">Motif</th>
                    <th width="48%">Explications</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="3">
                        <pre>curl https://sous-domaine.fr/docs</pre>
                </td>
            </tr>
            <tr class="vm">
                <td>@</td>
                <td>Tester l'acc√®s directement sur @</td>
                <td>Doit retourner du HTML</td>
            </tr>
            <tr>
                <td colspan="3">
                    <pre>docker logs <span id="containerNameResp4">[CONTAINER NAME]</span></pre>
                </td>
            </tr>
            <tr class="vm">
                <td>VM</td>
                <td>Si erreur 502 ou timeout</td>
                <td>Affiche les logs du conteneur pour diagnostiquer le probl√®me</td>
            </tr>
        </tbody>
    </table>


    <!-- √âTAPE 6 : OPTIONNEL - NETTOYAGE -->
    <div class="section-title" id="part16">
        √âTAPE 6Ô∏è‚É£ : OPTIONNEL - Nettoyer les anciennes versions
    </div>
    <table>
        <thead>
            <tr>
                <th width="4%">Shell</th>
                <th width="48%">Motif</th>
                <th width="48%">Explications</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="3">
                    <pre>docker ps -a | grep <span id="imagesResp2">[IMAGE]</span></pre>
                </td>
            </tr>
            <tr class="vm">
                <td>VM</td>
                <td>Lister tous les conteneurs avec le m√™me nom commun pour l'image (actifs + arr√™t√©s)</td>
                <td>-</td>
            </tr>
            <tr>
                <td colspan="3">
                    <pre>docker rm <span id="prevContainerIDResp2">[ancien CONTAINER ID]</span></pre>
                </td>
            </tr>
            <tr class="vm">
                <td>VM</td>
                <td>Supprimer le conteneur arr√™t√© (ancien)</td>
                <td>-</td>
            </tr>
            <tr>
                <td colspan="3">
                    <pre>docker rmi <span id="prevRepoResp1">[Ancien REPOSITORY]</span>:<span id="prevTagResp1">[Ancien TAG]</span></pre>
                </td>
            </tr>
            <tr class="vm">
                <td>VM</td>
                <td>Supprimer l'image Docker ancienne (optionnel)</td>
                <td><strong>rmi</strong> = remove image. Lib√®re l'espace dans l'instance cibl√©e. <br>
                    <b>‚ö†Ô∏è V√©rifier que l'image n'est pas utilis√©e dans un autre sous-domaine avant de la
                        supprimer</b>
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <pre>df -h /</pre>
                </td>
            </tr>
            <tr class="vm">
                <td>VM</td>
                <td><b>‚ö†Ô∏è V√©rifier l'espace disque lib√©r√©</b></td>
                <td><strong>df -h</strong> : affiche l'utilisation disque. La colonne "Use%" doit diminuer apr√®s le
                    nettoyage</td>
            </tr>
        </tbody>
    </table>

    <h2 id="part2">üìã R√©sum√© des impacts</h2>
    <table>
        <tbody>
            <tr class="safe">
                <td width="200px"><strong>‚úÖ Inchang√©</strong></td>
                <td>Nginx, Certbot, Firewall UFW, certificat SSL, domaine</td>
            </tr>
            <tr class="impact">
                <td><strong>‚ö†Ô∏è Downtime</strong></td>
                <td>~10-30 secondes (temps pour arr√™ter l'ancien conteneur et en lancer un nouveau)</td>
            </tr>
            <tr class="safe">
                <td><strong>‚úÖ Transparent</strong></td>
                <td>Pour l'utilisateur, c'est comme si rien ne s'√©tait pass√©. HTTPS reste actif pendant toute la
                    mise √† jour (Nginx = reverse proxy, l'acc√®s continue).</td>
            </tr>
        </tbody>
    </table>

    <h2 id="part3">üîÑ Rollback en cas de probl√®me (urgent)</h2>
    <div class="step">
        <div class="step-title">Si la v1 a un bug critique :</div>
        <ul>
            <li>
                <pre><code>docker stop <span id="containerNameResp5">[CONTAINER NAME]</span></code> : arr√™te la version buggu√©e</li>
                <li><pre><code>docker start <span id="prevContainerNameResp1">[Ancien CONTAINER NAME]</span></code> : relance l'ancienne version (si pas supprim√©e √† l'√©tape 6)</li>
                <li>Nginx redirige imm√©diatement vers le port <span id="networkVMResp2">[PORT RESEAU]</span> ‚Üí ancien conteneur ‚úÖ</li>
                <li>Dur√©e : ~10 sec. D√©pannage rapide !</li>
            </ul>
        </div>
        <br>
        <hr>

        <i><a href="#menu">Retour au menu</a></i><br><br>

        <i><a id='lien' href="./index.html">Retour au sommaire</a></i>
    </div>
    <script src="/index_ovh05.js"></script>
</body>

</html>