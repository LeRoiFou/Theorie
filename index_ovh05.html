<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©ploiement FastAPI + Nginx + HTTPS</title>
    <link rel="stylesheet" href="styleOVH.css">
</head>

<body>
    <div class="container">
        <h1>üöÄ D√©ploiement d'une application sur VM OVH avec le paquet Nginx + HTTPS</h1>

        <h2 id="menu">üë®‚Äçüç≥ Menu</h2>
        <div class="diagram">
            üîß <a href="#part1">BLOC 1 : Installation des paquets Nginx + Certbot</a> <br>
            üì¶ <a href="#part2">BLOC 2 : Pr√©paration Docker & Transfert vers VM</a><br>
            ‚öôÔ∏è <a href="#part3">BLOC 3 : Configuration Nginx Reverse Proxy</a> <br>
            üîí <a href="#part4">BLOC 4 : G√©n√©ration Certificat SSL Let's Encrypt</a>
        </div>

        <div class="diagram">
            ARCHITECTURE :
            ‚Üí Docker (PC)
            ‚Üí SCP (transfert)
            ‚Üí VM Ubuntu 22.04
            ‚Üí Nginx (reverse proxy)
            ‚Üí HTTPS (Let's Encrypt)

            <b>NB 1 :</b>
            ‚Üí <b>Le bloc 1 est √† appliquer pour chaque nouvelle instance (= VM)</b>
            ‚Üí <b>Le bloc 2 est √† appliquer pour chaque nouvelle application</b>
            ‚Üí <b>Les blocs 3 et 4 sont √† appliquer pour chaque nouveau sous-domaine</b>

            <b>NB 2 : une application est rattach√©e √† un sous-domaine qui est rattach√© √† un port r√©seau sp√©cifique
                (8000, ou 8001...)</b>
        </div>

        <!-- ZONE DE SAISIE -->
        <div class="section-title">ZONE DE SAISIE DES DONNEES</div>

        <label for="key">Nom de la cl√© priv√©e</label>
        <input type="text" name="key" id="key" value="id_ed25519"
            title="Nom par d√©faut de la cl√© priv√©e attribu√© par OVH"><br>

        <label for="ipv4">Adresse IPv4</label>
        <input type="text" name="ipv4" id="ipv4" placeholder="Adresse IPv4 sur OVH du projet cibl√©"><br>

        <label for="container">CONTAINER ID</label>
        <input type="text" name="container" id="container"
            placeholder="ID du conteneur √† supprimer (en VM : docker ps-a)"><br>

        <label for="repository">REPOSITORY</label>
        <input type="text" name="repository" id="repository"
            placeholder="Nom de l'image √† charger (en local : docker images)"
            title="Charger pr√©alablement docker desktop"><br>

        <label for="tag">TAG</label>
        <input type="text" name="tag" id="tag" placeholder="Version de l'image √† charger  (en local : docker images)"
            title="Par d√©faut, le nom de la version de l'image est latest"><br>

        <label for="network">Port r√©seau</label>
        <input type="text" name="network" id="network" placeholder="8000 pour fastapi, 8050 pour dash"><br>

        <label for="domain">Sous-domaine</label>
        <input type="text" name="domain" id="domain" placeholder="Nom du sous-domaine (par exempe test.datacofi)"><br>

        <button type="submit" id="btn">Valider</button>

        <!-- BLOC 1 : INSTALLATION NGINX + CERTBOT -->
        <div class="section-title" id="part1">üîß BLOC 1 <u>POUR CHAQUE NOUVELLE INSTANCE</u> : Installation des paquets
            Nginx + Certbot</div>
        <table>
            <thead>
                <tr>
                    <th width="80px">Shell</th>
                    <th width="400px">Motif</th>
                    <th>Explications</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="3">
                        <pre><code>sudo apt update && sudo apt upgrade -y</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Mettre √† jour les paquets</td>
                    <td><strong>sudo</strong> : mode administrateur <br>
                        <strong>apt update</strong> : r√©cup√®re les listes de paquets <br>
                        <strong>apt upgrade</strong> : installe les mises √† jour <br>
                        <strong>-y</strong> : r√©pondre "oui" automatiquement <br>
                        ‚è±Ô∏è 1-3 min
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>sudo apt install nginx certbot python3-certbot-nginx ufw -y</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Installer les paquets Nginx + Certbot + UFW</td>
                    <td><strong>nginx</strong> : reverse proxy <br>
                        <strong>certbot</strong> : gestion certificat SSL <br>
                        <strong>python3-certbot-nginx</strong> : plugin Certbot pour Nginx <br>
                        <strong>ufw</strong> : firewall <br>
                        ‚è±Ô∏è 1-2 min
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>sudo ufw allow 'Nginx Full' && sudo ufw allow 'OpenSSH' && sudo ufw enable</code></pre>
                    </td>
                </tr>
                <tr class="critical">
                    <td>VM</td>
                    <td>Configurer le firewall UFW</td>
                    <td><strong>CRITIQUE :</strong> Ajoute OpenSSH AVANT d'activer le firewall ! Sinon tu seras bloqu√©.
                        <br>
                        <ul>
                            <li><strong>sudo ufw allow 'Nginx Full'</strong> : autorise ports 80 + 443 (HTTP+HTTPS)</li>
                            <li><strong>sudo ufw allow 'OpenSSH'</strong> : autorise SSH (port 22)</li>
                            <li><strong>sudo ufw enable</strong> : active le firewall (pare-feu)</li>
                        </ul>
                        Lorsque la partie sudo ufw enable va se lancer, le serveur va poser une question de s√©curit√© :
                        <br>
                        <pre><code>Command may disrupt existing ssh connections. Proceed with operation (y|n)?</code></pre>
                        R√©ponds : y (puis Entr√©e) √©vitant que la connexion soit coup√©e en autorisant openSSH avant
                        le firewall
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>sudo systemctl start nginx && sudo systemctl enable nginx</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>D√©marrer Nginx</td>
                    <td><strong>start</strong> : lance le service imm√©diatement <br>
                        <strong>enable</strong> : le red√©marre automatiquement au boot du VM
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>sudo systemctl status nginx</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>V√©rifier que Nginx fonctionne</td>
                    <td>Doit afficher
                        <pre><code>active (running)</code> en vert ‚úÖ. Appuie sur <strong>Q</strong> pour quitter</td>
                </tr>
            </tbody>
        </table>

        <!-- BLOC 2 : DOCKER & TRANSFERT -->
        <div class="section-title" id="part2">üì¶ BLOC 2 <u>POUR CHAQUE NOUVELLE APPLICATION</u> : Pr√©paration Docker & Transfert vers VM</div>
        <table>
            <thead>
                <tr>
                    <th width="80px">Shell</th>
                    <th width="400px">Motif</th>
                    <th>Explications</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="3">
                        <pre><code>ssh -i $env:USERPROFILE\.ssh\<span id="keyResponse1">[CLE]</span> ubuntu@<span
                                                id="ipv4Response1">[IPv4]</span></code></pre>
                    </td>
                </tr>
                <tr class="local">
                    <td>Local</td>
                    <td>Se connecter au VM en SSH</td>
                    <td>Tu entres maintenant dans le shell du VM</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>docker --version</code></pre>
                    </td>
                </tr>
                <tr>
                    <td>VM</td>
                    <td>Permet de v√©rifier si Docker a bien √©t√© install√© sur la VM</td>
                    <td>Dans l'affirmative, on aura une r√©ponse du style <i>Docker version 28.2.2, build
                            28.2.2-0ubuntu1~22.04.1</i></td>
                </tr>
                </tr>
                <td colspan="3">
                    <ul>
                        <li>
                            <pre><code>sudo apt install docker.io -y</code></pre>
                        </li>
                        <li>
                            <pre><code>sudo usermod -aG docker ubuntu</code></pre>
                        </li>
                    </ul>
                </td>
                <tr>
                    <td>VM</td>
                    <td>Si Docker n'est pas install√©</td>
                    <td>Mise √† jour des paquets disponibles + installation de Docker dans la VM</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>exit</code></pre>
                    </td>
                </tr>
                <tr>
                    <td>VM</td>
                    <td>Retour dans le shell en local</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>docker images</code></pre>
                    </td>
                </tr>
                <tr class="local">
                    <td>Local</td>
                    <td>R√©cup√©rer REPOSITORY et TAG de ton image</td>
                    <td>Affiche toutes les images disponibles
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>docker ps -a</code></pre>
                    </td>
                </tr>
                <tr>
                    <td>Local</td>
                    <td>Permet d'afficher la liste des conteneurs ex√©cut√©s / arr√™t√©s, avec les statuts
                        suivants :
                        <ul>
                            <li>Exited (0) : <i>aucune erreur</i></li>
                            <li>Exited (1) : <i>au moins une erreur pr√©sente</i></li>
                            <li>Exited (137) : <i>conteneur arr√™t√© / forc√© / manque de m√©moire</i>
                            </li>
                        </ul>
                    </td>
                    <td>
                        <ul>
                            <li><b>ps</b> : vient de ‚Äúprocess status‚Äù. Historiquement, ps est une
                                commande
                                Unix qui affiche l‚Äô√©tat des processus en cours, et
                                Docker a
                                repris ce nom pour afficher l‚Äô√©tat des conteneurs
                            </li>
                            <li><b>-a</b> : signifie 'all'</li>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>docker logs <span id="containerResponse1">[CONTAINER_ID]</span></code></pre>
                    </td>
                </tr>
                <tr>
                    <td>Local</td>
                    <td>Si un des conteneurs a le statut Exited (1) ou Exited (137)</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>docker save <span id="repoResponse1">[REPOSITORY]</span>:<span id="tagResponse1">[TAG]</span> -o <span id="repoResponse2">[REPOSITORY]</span>.tar</code></pre>
                    </td>
                </tr>
                <tr class="local">
                    <td>Local</td>
                    <td>Exporter l'image en fichier .tar</td>
                    <td><strong>-o</strong> : output
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>ls -lh <span id="repoResponse3">[REPOSITORY]</span>.tar</code></pre>
                    </td>
                </tr>
                <tr class="local">
                    <td>Local</td>
                    <td>V√©rifier que le .tar existe</td>
                    <td><strong>ls -lh</strong> : liste d√©taill√©e avec taille lisible (Mo, Go). Si absent, l'export a
                        √©chou√©
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>scp -i $env:USERPROFILE\.ssh\<span id="keyResponse2">[CLE]</span> <span id="repoResponse4">[REPOSITORY]</span>.tar ubuntu@<span
                                                id="ipv4Response2">[IPV4]</span>:/home/ubuntu/</code></pre>
                    </td>
                </tr>
                <tr class="local">
                    <td>Local</td>
                    <td>Copier le fichier .tar vers le VM</td>
                    <td><strong>scp</strong> : Secure Copy via SSH</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>ssh -i $env:USERPROFILE\.ssh\<span id="keyResponse3">[CLE]</span> ubuntu@<span
                                                id="ipv4Response3">[IPV4]</span></code></pre>
                    </td>
                </tr>
                <tr class="local">
                    <td>Local</td>
                    <td>Se connecter au VM en SSH</td>
                    <td>Tu entres maintenant dans le shell du VM</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>ls -lh <span id="repoResponse5">[REPOSITORY]</span>.tar</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>V√©rifier la r√©ception du fichier</td>
                    <td>Si le fichier appara√Æt, le transfert SCP a r√©ussi ‚úÖ</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>docker load -i <span id="repoResponse6">[REPOSITORY]</span>.tar</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Charger l'image Docker dans le VM</td>
                    <td>Cr√©e l'image Docker localement sur le VM
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>docker images</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>V√©rifier que l'image est charg√©e</td>
                    <td>Ton image doit appara√Ætre dans la liste ‚úÖ</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>docker run -d --restart unless-stopped --name <span id="domainResponse1">[SOUS_DOMAINE]</span> -p <span id="networkResponse1">[PORT_RESEAU:PORT_RESEAU]</span> <span id="repoResponse7">[REPOSITORY]</span>:<span id="tagResponse2">[TAG]</span></code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Lancer le conteneur Docker</td>
                    <td><strong>-d</strong> : mode d√©tach√© (arri√®re-plan) <br>
                        <strong>--restart unless-stopped</strong> :
                        relance auto si crash <br>
                        <strong>-p 8000:8000</strong> : mappe port interne au port VM <br>
                        <strong>--name fastapi-app</strong> : nom du conteneur pour le retrouver facilement
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>docker ps</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>V√©rifier que le conteneur tourne</td>
                    <td>-</td>
                </tr>
            </tbody>
        </table>

        <!-- BLOC 3 : CONFIGURATION NGINX -->
        <div class="section-title" id="part3">‚öôÔ∏è BLOC 3 <u>POUR CHAQUE NOUVEAU SOUS-DOMAINE</u> : Configuration Nginx
            Reverse Proxy</div>
        <table>
            <thead>
                <tr>
                    <th width="80px">Shell</th>
                    <th width="400px">Motif</th>
                    <th>Explications</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="3">
                        <pre><code>sudo nano /etc/nginx/sites-available/<span id="domainResponse2">[SOUS_DOMAINE]</span>.fr</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Cr√©er le fichier de config Nginx</td>
                    <td><strong>nano</strong> : √©diteur texte simple. Ouvre un fichier vierge pour √©dition</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>server {
    listen 80;
    listen [::]:80;
    server_name <span id="domainResponse3">[SOUS_DOMAINE]</span>.fr;

    location / {
        proxy_pass http://127.0.0.1:[PORT RESEAU];
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
}</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Contenu √† coller dans nano</td>
                    <td><strong>listen 80</strong> : √©coute HTTP port 80 <br>
                        <strong>server_name app.datacofi.fr</strong> :
                        r√©pondra √† ce domaine <br>
                        <strong>proxy_pass http://127.0.0.1:8000</strong> : redirige vers Docker sur
                        port 8000 <br>
                        <strong>proxy_set_header</strong> : transmet infos client <br>
                        <strong>proxy_*_timeout</strong> : d√©lais pour ne pas crash <br><br>
                        ‚ûú Clic droit = coller, puis <strong>Ctrl+X</strong> ‚Üí <strong>Y</strong> ‚Üí
                        <strong>Enter</strong>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre><code>sudo ln -s /etc/nginx/sites-available/<span id="domainResponse4">[SOUS_DOMAINE]</span>.fr /etc/nginx/sites-enabled/</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Activer le site dans Nginx</td>
                    <td><strong>ln -s</strong> : cr√©e un lien symbolique (raccourci). Nginx lit les configs de
                        sites-enabled/ au d√©marrage</td>
                </tr>
                <tr>
                    <td colspan="3">
                </tr>
        </table>

        <!-- BLOC 4 : G√âN√âRATION CERTIFICAT SSL -->
        <div class="section-title" id="part4">üîí BLOC 4 <u>POUR CHAQUE NOUVEAU SOUS-DOMAINE</u> : G√©n√©ration Certificat
            SSL Let's Encrypt</div>
        <table>
            <thead>
                <tr>
                    <th width="80px">Shell</th>
                    <th width="400px">Motif</th>
                    <th>Explications</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="3">
                        <pre>de>sudo nginx -t</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Tester la syntaxe Nginx</td>
                    <td>Doit afficher "syntax is ok" et "test is successful" ‚úÖ Si erreur, le config Nginx a
                        un probl√®me.</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre>de>sudo systemctl reload nginx</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Recharger Nginx avec le nouveau config</td>
                    <td>Applique le reverse proxy pour le sous-domaine. Sans erreur = ‚úÖ</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre>de>sudo certbot --nginx -d <span id="domainResponse5">[SOUS_DOMAINE]</span>.fr</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>G√©n√©rer certificat SSL Let's Encrypt</td>
                    <td><strong>--nginx</strong> : Certbot configure auto Nginx avec HTTPS <br>
                        <strong>-d <span id="domainResponse6">[SOUS_DOMAINE]</span>.fr</strong> : domaine √† s√©curiser
                        <br><br>
                        Certbot va : <br>
                        1) V√©rifier que le domaine pointe bien sur ce VM, <br>
                        2) G√©n√©rer un certificat valide 90 jours, <br>
                        3) Modifier le config Nginx pour activer HTTPS <br><br>
                        ‚è±Ô∏è 1-2 min : tu verra des prompts - accepte les conditions Let's Encrypt.
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre>de>sudo certbot renew --dry-run</code></pre>
                    </td>
                </tr>
                <tr class="vm">
                    <td>VM</td>
                    <td>Tester le renouvellement automatique</td>
                    <td><strong>--dry-run</strong> : teste le renouvellement sans le faire vraiment <br><br>
                        Doit afficher "Congratulations" ‚úÖ Certbot renouvellera auto 30 jours avant expiration via
                        cron</td>
                </tr>
                <tr>
                    <td colspan="3">
                        <pre>de>curl https://<span id="domainResponse7">[SOUS_DOMAINE]</span>.fr</code></pre>
                    </td>
                </tr>
                <tr class="safe">
                    <td>VM</td>
                    <td>Tester HTTPS depuis le VM</td>
                    <td>Si aucune erreur SSL, le certificat fonctionne ‚úÖ <br><br>
                        Tu peux aussi ouvrir
                        https://<span id="domainResponse8">[SOUS_DOMAINE]</span>.fr dans ton navigateur (cadenas vert =
                        certificat valide).</td>
                </tr>
            </tbody>
        </table>
        <hr>

        <i><a href="#menu">Retour au menu</a></i><br><br>

        <i><a id='lien' href="./index.html">Retour au sommaire</a></i>

    </div>

    <script src="index_ovh05.js"></script>
</body>

</html>